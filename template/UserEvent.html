<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Events</title>
    <link rel="stylesheet" href="css/UserEvent.css">
</head>

<body>
    <header>
        <div class="navbar">
            <div class="nav-title">
                <h2>EventRiders</h2>
            </div>
            <div class="nav-links">
                <a href="Events.html">Home</a>
                <a href="UserEvent.html">Your Events</a>
                <a href="Userbookings.html">Your Bookings</a>
            </div>
            <a class="logout" onclick="LogOut()">Logout</a>
        </div>
    </header>
    <main>
        <div class="events-container" id="eventsContainer">
        </div>
    </main>
    <button class="add-event-button" onclick="window.location.href='addevent.html'">Add Event</button>

    <script>
        const token = localStorage.getItem('jwtToken');
        const id = localStorage.getItem('id');

        function fetchEvents(url) {
            fetch(url, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
            })
                .then(response => {
                    if (response.status === 401) {
                        alert("Unauthorized!!");
                        window.location.href = 'Login.html';
                        return;
                    }
                    else if (!response.ok) {
                        return response.json().then(data => {
                            throw new Error(data.message);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Success:', data);
                    displayEvents(data);
                })
                .catch((error) => {
                    console.error('Error:', error);
                    alert(`Event Fetch failed: ${error.message}`);
                });
        }


        function displayEvents(events) {
            const eventsContainer = document.getElementById('eventsContainer');
            eventsContainer.innerHTML = '';
            events.forEach(event => {
                const card = createEventCard(event);
                eventsContainer.appendChild(card);
            });
        }

        function createEventCard(event) {
            const card = document.createElement('div');
            card.classList.add('event-card');

            const name = document.createElement('h2');
            name.textContent = event.name;
            card.appendChild(name);

            const city = document.createElement('p');
            city.classList.add('event-city');
            city.textContent = `City: ${event.city}`;
            card.appendChild(city);

            const seats = document.createElement('p');
            let SeatLeft = event.max_seat - event.enrolled_count;
            seats.classList.add('seatsleft');
            seats.textContent = `Seats Left: ${SeatLeft}`;
            card.appendChild(seats);

            const fees = document.createElement('p');
            fees.classList.add('event-fees');
            fees.textContent = `Fees: ₹${event.fees}`;
            card.appendChild(fees);

            const date = document.createElement('p');
            date.classList.add('event-date');
            date.textContent = `Date: ${event.date}`;
            card.appendChild(date);

            const time = document.createElement('p');
            time.classList.add('event-time');
            time.textContent = `Time: ${event.time}`;
            card.appendChild(time);

            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'Delete';
            deleteButton.classList.add('delete-button');
            deleteButton.onclick = () => deleteEvent(event.eventid);
            card.appendChild(deleteButton);

            const updateButton = document.createElement('button');
            updateButton.textContent = 'Update';
            updateButton.classList.add('update-button');
            updateButton.onclick = () => updateEvent(event);
            card.appendChild(updateButton);
            console.log(event);
            return card;
        }

        fetchEvents(`http://192.168.1.83:8080/events?creator=${id}`);

        function deleteEvent(eventId) {
            const token = localStorage.getItem('jwtToken');
            const url = `http://192.168.1.83:8080/events?id=${eventId}`;

            fetch(url, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
            })
                .then(response => {
                    if (response.status === 401) {
                        alert("Unauthorized!!");
                        window.location.href = 'Login.html';
                        return;
                    } else if (!response.ok) {
                        return response.json().then(data => {
                            throw new Error(data.message);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Success:', data);
                    fetchEvents('http://192.168.1.83:8080/events');
                })
                .catch((error) => {
                    console.error('Error:', error);
                    /*alert(`Event deletion failed: ${error.message}`);*/
                });
        }

        function updateEvent(eventData) {

            console.log(eventData);

            localStorage.setItem('UpdateData', JSON.stringify(eventData));

            window.location.href = `UpdateEvent.html`;
        }

        function LogOut() {
            localStorage.removeItem('jwtToken');
            localStorage.removeItem('id');
            alert("Logged Out Successfully");
            window.location.href = "Login.html";
        }

    </script>

</body>

</html>
